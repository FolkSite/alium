Описание
========

Система Alium - набор скриптов, обслуживающий рутинные операции магазина Merchium.

Она предназначена для:

1. Отслеживания изменения цен и наличия товара
2. Обновления цен по заложенным бизнес-правилам
3. Добавления товаров в Merchium

Системные требования
====================

* PHP 5.4+ (используется trait), расширение `shmop`, см. вывод php –m | grep shmop (или инициировать `phpmorphy` как `PHPMORPHY_STORAGE_MEM`)
* MongoDB 2+
* (MySQL 5.2+)

Составные части и терминология
==============================

* Мерчиум (Merchium)
* Алиум (Alium)
* Алиэкспресс (Ali)

Для предотвращения путаницы следует использовать следующие термины:

`fetch` - импорт товаров Merchium->Alium

`pull` - экспорт товаров Alium->Merchium

`import` - импорт товаров Ali->Merchium

`update` - обновление каких-либо данных

Другими словами, импорт в БД Алиума товаров из Мерчиума это `fetch`, а назад - `pull`, чтобы не путать с импортом из Ali.

Установка и настройка
=====================

(Переименовать файл `etc/config.dist.php` в `config.php` и настроить.)

Создать проект по примеру `projects/example.json`:

`name` - имя проекта, как в Мерчиуме, это важно

`uri` - URI проекта

`mongo.db` - название БД проекта

`mongo.collection` - название коллекции проекта

`price.closure` - замыкание, рассчитывающее цену

`price.round` - округлять цену?

`price.sweet` - уменьшать цену на рубль (работает при округлении цены)?

`shopPolicy` - политика автоматического импорта товаров по URI:

`shopPolicy.category` - категория, куда будет произведен импорт

`shopPolicy.taxes` - налог

Создать уникальный индекс по `id`:

        use dbname;
        db.collection.ensureIndex({id: 1}, {unique: true});


Порядок работы
==============

Фактически Алиум хранит данные Мерчиума, дополнив их дополнительными (история изменения цен, последнее обновление, внутренние данные).

Так как систем хранения товаров фактически две (Мерчиум - отдельно, Алиум - отдельно), API Алиума еще не сделан, приличного способа синхронизации нет. Вся синхронизация осуществляется посредством файлов CSV.

Поэтому следует полностью исключить ручной способ наполнения, отдав предпочтение полуавтоматическому.

Вручную также возможно наполнять, придерживаться принципа "Поработал с одной системой, обновил вторую". Максимальный вред, нанесенный при неправильном порядке - товары Мерчиума или Алиума будут затерты новыми товарами, общая часть сохранится. Из-за этого заказы могут содержать "новые товары".

Наполнение Мерчиума
-------------------

Запуск `4-ali-import` с последующей синхронизацией (pull) и проверкой. Перемещение товаров в категории, добавление свойств, работа с текстами.

Заполнение БД Алиума
--------------------

Файл `1-fetch-alium.php`

Применяется к CSV-выгрузке Merchiumа. Обновляет данные Алиума и загружает недостающие товары (если они были добавлены вручную).

Обновление БД Алиума
--------------------

Файл `2-update-alium.php`

Запускается и автоматически обновляет данные магазина из интернет-магазина (Алиэкспресс).


Обновление магазина Merchium
----------------------------

Файл `3-pull-merchium.php`

Экспорт в CSV необходимых данных. Для обновления только цен и остатков - параметр price.
